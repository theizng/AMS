<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AMS.Views.ReportsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:conv="clr-namespace:AMS.Converters"
    xmlns:vm="clr-namespace:AMS.ViewModels"
    xmlns:mc="clr-namespace:Microcharts.Maui;assembly=Microcharts.Maui"
    Title="Báo cáo và thống kê">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:PaymentStatusToColorConverter x:Key="PaymentStatusToColorConverter" />
            <conv:StringNotEmptyConverter x:Key="StringNotEmptyConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="14" Spacing="14">

            <!-- Top KPIs -->
            <Grid ColumnDefinitions="*,*,*" ColumnSpacing="10">
                <Frame Padding="12" CornerRadius="12" BorderColor="#CFD8DC">
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{DynamicResource TextPrimary}" Text="Doanh thu tháng này" FontAttributes="Bold" FontSize="14"/>
                        <Label Style="{DynamicResource TextPrimary}" Text="{Binding CurrentMonthRevenue, StringFormat='{0:N0} đ'}"
                               FontSize="18" TextColor="#1B5E20"/>
                    </VerticalStackLayout>
                </Frame>
                <Frame Padding="12" CornerRadius="12" BorderColor="#CFD8DC">
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{DynamicResource TextPrimary}" Text="Lợi nhuận tháng này" FontAttributes="Bold" FontSize="14"/>
                        <Label Style="{DynamicResource TextPrimary}" Text="{Binding CurrentMonthProfit, StringFormat='{0:N0} đ'}"
                               FontSize="18" TextColor="#004D40"/>
                    </VerticalStackLayout>
                </Frame>
                <Frame Padding="12" CornerRadius="12" BorderColor="#CFD8DC">
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{DynamicResource TextPrimary}" Text="Số người thuê" FontAttributes="Bold" FontSize="14"/>
                        <Label Style="{DynamicResource TextPrimary}" Text="{Binding CurrentTenantCount}"
                               FontSize="18" TextColor="#0D47A1"/>
                    </VerticalStackLayout>
                </Frame>
            </Grid>

            <!-- Export -->
            <HorizontalStackLayout Spacing="8">
                <Button Style="{DynamicResource TextPrimary}" Text="Xuất PDF" Command="{Binding ExportPdfCommand}" />
                <Button Style="{DynamicResource TextPrimary}" Text="Xuất Excel" Command="{Binding ExportExcelCommand}" />
            </HorizontalStackLayout>

            <!-- Charts row -->
            <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                <!-- Revenue/Profit chart -->
                <Frame Grid.Column="0" Padding="10" CornerRadius="12" BorderColor="#CFD8DC">
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{DynamicResource TextPrimary}" Text="Doanh thu và Lợi nhuận (năm nay)" FontAttributes="Bold" />
                        <mc:ChartView Chart="{Binding RevenueProfitChart}"
                                      HorizontalOptions="FillAndExpand"
                                      VerticalOptions="FillAndExpand">
                            <mc:ChartView.HeightRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="WinUI, MacCatalyst">360</On>
                                    <On Platform="Android, iOS">230</On>
                                </OnPlatform>
                            </mc:ChartView.HeightRequest>
                        </mc:ChartView>
                    </VerticalStackLayout>
                </Frame>

                <!-- Paid/Unpaid pie (optional but safe) -->
                <Frame Grid.Column="1" Padding="10" CornerRadius="12" BorderColor="#CFD8DC">
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{DynamicResource TextPrimary}" Text="Thanh toán tháng này" FontAttributes="Bold" />
                        <mc:ChartView Chart="{Binding PaidUnpaidPie}"
                                      HorizontalOptions="FillAndExpand"
                                      VerticalOptions="FillAndExpand">
                            <mc:ChartView.HeightRequest>
                                <OnPlatform x:TypeArguments="x:Double">
                                    <On Platform="WinUI, MacCatalyst">320</On>
                                    <On Platform="Android, iOS">220</On>
                                </OnPlatform>
                            </mc:ChartView.HeightRequest>
                        </mc:ChartView>
                    </VerticalStackLayout>
                </Frame>
            </Grid>

            <!-- Debts list (RoomCode + AmountRemaining) -->
            <Frame Padding="10" CornerRadius="12" BorderColor="#CFD8DC">
                <VerticalStackLayout Spacing="8">
                    <Label Style="{DynamicResource TextPrimary}" Text="Danh sách phòng còn nợ" FontAttributes="Bold" FontSize="16"/>
                    <CollectionView ItemsSource="{Binding Debts}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="*,Auto" ColumnSpacing="8" Padding="4">
                                    <Label Style="{DynamicResource TextPrimary}" Grid.Column="0" Text="{Binding RoomCode}" FontAttributes="Bold"/>
                                    <Label Style="{DynamicResource TextPrimary}" Grid.Column="1"
                                           Text="{Binding AmountRemaining, StringFormat='{0:N0} đ'}"
                                           TextColor="#C62828"
                                           HorizontalTextAlignment="End"/>
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>