<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AMS.Views.PaymentsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:mc="clr-namespace:Microcharts.Maui;assembly=Microcharts.Maui"
    xmlns:conv="clr-namespace:AMS.Converters"
    Title="Chu kỳ thanh toán">

    <ContentPage.ToolbarItems>
        <ToolbarItem Text="Tạo chu kỳ" Priority="0" Order="Primary" Command="{Binding CreateCycleCommand}" />
        <ToolbarItem Text="Đồng bộ phòng" Priority="1" Order="Primary" Command="{Binding ReseedCommand}" />
        <ToolbarItem Text="Làm mới" Priority="2" Order="Primary" Command="{Binding RecomputeCommand}" />
        <ToolbarItem Text="Gửi hóa đơn cho tất cả phòng" Priority="3" Order="Secondary" Command="{Binding SendAllWithInvoiceCommand}" />
    </ContentPage.ToolbarItems>

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:PaymentStatusToBadgeColorConverter x:Key="StatusBadgeBgConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="12" RowSpacing="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <HorizontalStackLayout Grid.Row="0" Spacing="8">
            <Picker 
                Style="{DynamicResource TextPrimary}"
                Title="Chọn chu kỳ"
                WidthRequest="200"
                ItemsSource="{Binding Cycles}"
                ItemDisplayBinding="{Binding Display}"
                SelectedItem="{Binding SelectedCycle}" />
        </HorizontalStackLayout>

        <VerticalStackLayout Grid.Row="1" Spacing="8">
            <!-- KPIs unchanged -->
            <Grid ColumnDefinitions="*,*" RowDefinitions="Auto,Auto" ColumnSpacing="8" RowSpacing="8">
                <!-- frames unchanged -->
                <Frame Grid.Row="0" Grid.Column="0" Padding="8" CornerRadius="8" BorderColor="#CFD8DC">
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{DynamicResource TextPrimary}" Text="Tổng phải thu" FontAttributes="Bold"/>
                        <Label Style="{DynamicResource TextPrimary}" Text="{Binding TotalDue, StringFormat='{0:N0} đ'}" />
                    </VerticalStackLayout>
                </Frame>
                <Frame Grid.Row="0" Grid.Column="1" Padding="8" CornerRadius="8" BorderColor="#CFD8DC">
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{DynamicResource TextPrimary}" Text="Đã thu" FontAttributes="Bold"/>
                        <Label Style="{DynamicResource TextPrimary}" Text="{Binding TotalPaid, StringFormat='{0:N0} đ'}" />
                    </VerticalStackLayout>
                </Frame>
                <Frame Grid.Row="1" Grid.Column="0" Padding="8" CornerRadius="8" BorderColor="#CFD8DC">
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{DynamicResource TextPrimary}" Text="Còn lại" FontAttributes="Bold"/>
                        <Label Style="{DynamicResource TextPrimary}" Text="{Binding TotalRemaining, StringFormat='{0:N0} đ'}" />
                    </VerticalStackLayout>
                </Frame>
                <Frame Grid.Row="1" Grid.Column="1" Padding="8" CornerRadius="8" BorderColor="#CFD8DC">
                    <VerticalStackLayout Spacing="4">
                        <Label Style="{DynamicResource TextPrimary}" Text="Sẵn sàng gửi" FontAttributes="Bold"/>
                        <Label Style="{DynamicResource TextPrimary}" Text="{Binding ReadyCount}" />
                    </VerticalStackLayout>
                </Frame>
            </Grid>

            <Label
                Style="{DynamicResource TextPrimary}" Text="{Binding StatusMessage} "
                TextColor="#FF7043"
                FontSize="12"
                IsVisible="{Binding StatusMessage, Converter={StaticResource StringNotEmptyConverter}}" />

            <Label
                Style="{DynamicResource TextPrimary}"
                Text="{Binding DueReminderMessage}"
                TextColor="#D92C54"
                FontAttributes="Bold"
                FontSize="13"/>
        </VerticalStackLayout>

        <CollectionView Grid.Row="2" ItemsSource="{Binding Rows}" SelectionMode="None">
            <CollectionView.EmptyView>
                <Grid Padding="20">
                    <Label
                        Style="{DynamicResource TextPrimary}" Text="Chưa có dữ liệu cho chu kỳ đã chọn."
                        HorizontalOptions="Center"
                        VerticalOptions="Center"
                        TextColor="#666" />
                </Grid>
            </CollectionView.EmptyView>
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Frame Margin="0,6" Padding="12" HasShadow="True" BorderColor="#E0E0E0" CornerRadius="10">
                        <Grid ColumnSpacing="12" RowSpacing="8">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Label Style="{DynamicResource TextPrimary}" Grid.Row="0" Grid.Column="0"
                                   Text="{Binding RoomCode}" FontAttributes="Bold" />

                            <!-- Badge hidden for MissingData / ReadyToSend -->
                            <Border Grid.Row="0" Grid.Column="1" Padding="10,5"
                                    IsVisible="{Binding ShowStatusBadge}"
                                    Background="{Binding Source.Status, Converter={StaticResource StatusBadgeBgConverter}}"
                                    StrokeThickness="0"
                                    HorizontalOptions="End" VerticalOptions="Start">
                                <Border.StrokeShape>
                                    <RoundRectangle CornerRadius="12" />
                                </Border.StrokeShape>
                                <Label Text="{Binding StatusText}"
                                       TextColor="White"
                                       FontAttributes="Bold"
                                       FontSize="12"/>
                            </Border>

                            <Label Style="{DynamicResource TextPrimary}" Grid.Row="1" Grid.ColumnSpan="2"
                                   Text="{Binding Summary}" LineBreakMode="TailTruncation" MaxLines="4" />

                            <Grid Grid.Row="2" Grid.ColumnSpan="2" ColumnDefinitions="*,Auto" ColumnSpacing="12">
                                <Grid Grid.Column="0" />
                                <VerticalStackLayout Grid.Column="1" Spacing="6" HorizontalOptions="End">

                                    <Button Text="Cập nhật trạng thái"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ChooseStatusCommand}"
                                            CommandParameter="{Binding .}" />

                                    <Button Text="Gửi hóa đơn (PDF)"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.SendInvoiceEmailCommand}"
                                            CommandParameter="{Binding .}">
                                        <Button.Triggers>
                                            <!-- Normal color when sendable -->
                                            <DataTrigger TargetType="Button" Binding="{Binding CanSendInvoice}" Value="True">
                                                <Setter Property="BackgroundColor" Value="#1976D2"/>
                                                <Setter Property="TextColor" Value="White"/>
                                            </DataTrigger>
                                            <!-- Inverted when not sendable -->
                                            <DataTrigger TargetType="Button" Binding="{Binding CanSendInvoice}" Value="False">
                                                <Setter Property="BackgroundColor" Value="White"/>
                                                <Setter Property="BorderColor" Value="#D92C54"/>
                                                <Setter Property="BorderWidth" Value="1"/>
                                                <Setter Property="TextColor" Value="#D92C54"/>
                                            </DataTrigger>
                                        </Button.Triggers>
                                    </Button>

                                    <!-- Optional: show missing reasons preview -->
                                    <Label FontSize="11" TextColor="#D92C54"
                                           IsVisible="{Binding CanSendInvoice, Converter={StaticResource InvertBoolConverter}}"
                                           Text="{Binding MissingReasonsText}" />
                                </VerticalStackLayout>
                            </Grid>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </Grid>
</ContentPage>