<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AMS.Views.PaymentsPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:conv="clr-namespace:AMS.Converters"
    Title="Tổng quan thanh toán">

    <ContentPage.Resources>
        <ResourceDictionary>
            <conv:PositiveAmountToBoolConverter x:Key="PositiveAmountToBoolConverter" />
            <conv:PaymentStatusToColorConverter x:Key="PaymentStatusToColorConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="14" Spacing="12">

            <!-- Cycle controls -->
            <Grid ColumnDefinitions="Auto,Auto,*,Auto,Auto" ColumnSpacing="8">
                <Picker Grid.Column="0" Title="Tháng"
                        ItemsSource="{Binding Months}" SelectedItem="{Binding SelectedMonth}" WidthRequest="110"/>
                <Picker Grid.Column="1" Title="Năm"
                        ItemsSource="{Binding Years}" SelectedItem="{Binding SelectedYear}" WidthRequest="110"/>
                <Entry Grid.Column="2" Placeholder="Tìm phòng..." Text="{Binding SearchText}" />
                <Button Grid.Column="3" Text="Tải" Command="{Binding LoadCommand}" />
                <Button Grid.Column="4" Text="Tạo chu kỳ" Command="{Binding CreateCycleCommand}" />
            </Grid>

            <!-- Summary -->
            <Grid ColumnDefinitions="*,*,*,*" Padding="0,8" ColumnSpacing="10">
                <Frame Padding="10" BorderColor="#CFD8DC" CornerRadius="10">
                    <VerticalStackLayout>
                        <Label Text="Phải thu" FontAttributes="Bold"/>
                        <Label Text="{Binding TotalDue, StringFormat='{0:N0} đ'}"/>
                    </VerticalStackLayout>
                </Frame>
                <Frame Padding="10" BorderColor="#CFD8DC" CornerRadius="10">
                    <VerticalStackLayout>
                        <Label Text="Đã thu" FontAttributes="Bold"/>
                        <Label Text="{Binding TotalPaid, StringFormat='{0:N0} đ'}"/>
                    </VerticalStackLayout>
                </Frame>
                <Frame Padding="10" BorderColor="#CFD8DC" CornerRadius="10">
                    <VerticalStackLayout>
                        <Label Text="Còn lại" FontAttributes="Bold"/>
                        <Label Text="{Binding TotalRemaining, StringFormat='{0:N0} đ'}" TextColor="#D84315"/>
                    </VerticalStackLayout>
                </Frame>
                <Frame Padding="10" BorderColor="#CFD8DC" CornerRadius="10">
                    <VerticalStackLayout>
                        <Label Text="Trễ hạn" FontAttributes="Bold"/>
                        <Label Text="{Binding LateCount}"/>
                    </VerticalStackLayout>
                </Frame>
            </Grid>

            <!-- Room list -->
            <CollectionView ItemsSource="{Binding RoomCharges}" SelectionMode="None">
                <CollectionView.EmptyView>
                    <Grid Padding="20">
                        <Label Text="Chưa có dữ liệu tháng này." HorizontalOptions="Center" VerticalOptions="Center" TextColor="#666"/>
                    </Grid>
                </CollectionView.EmptyView>

                <CollectionView.ItemTemplate>
                    <DataTemplate>
                        <Frame Padding="12" Margin="0,6" BorderColor="#CFD8DC" CornerRadius="10">
                            <Grid ColumnDefinitions="*,Auto" RowDefinitions="Auto,Auto,Auto" ColumnSpacing="8">
                                <HorizontalStackLayout Grid.Row="0" Grid.ColumnSpan="2" Spacing="8">
                                    <Label Text="{Binding RoomCode}" FontAttributes="Bold" />
                                    <Border Padding="10,4" StrokeThickness="0" Background="{Binding Status, Converter={StaticResource PaymentStatusToColorConverter}}">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12"/>
                                        </Border.StrokeShape>
                                        <Label Text="{Binding Status}" FontAttributes="Bold" />
                                    </Border>
                                </HorizontalStackLayout>

                                <VerticalStackLayout Grid.Row="1" Spacing="4">
                                    <Label Text="{Binding TotalDue, StringFormat='Tổng: {0:N0} đ'}"/>
                                    <Label Text="{Binding AmountPaid, StringFormat='Đã trả: {0:N0} đ'}"/>
                                    <Label Text="{Binding AmountRemaining, StringFormat='Còn: {0:N0} đ'}" TextColor="#D84315"/>
                                </VerticalStackLayout>

                                <HorizontalStackLayout Grid.Row="2" Grid.Column="1" Spacing="6" HorizontalOptions="End">
                                    <Button Text="Ghi nhận"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.RecordPaymentCommand}"
                                            CommandParameter="{Binding .}" />
                                    <Button Text="Trả một phần"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.MarkPartialCommand}"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding AmountRemaining, Converter={StaticResource PositiveAmountToBoolConverter}}"/>
                                    <Button Text="Đã trả"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.MarkPaidCommand}"
                                            CommandParameter="{Binding .}"
                                            IsVisible="{Binding AmountRemaining, Converter={StaticResource PositiveAmountToBoolConverter}}"/>
                                </HorizontalStackLayout>
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>

            <Button Text="Gửi nhắc trễ hạn (toàn chu kỳ)"
                    Command="{Binding SendLateRemindersCommand}"
                    BackgroundColor="#FFECB3"
                    Margin="0,8,0,0"/>
        </VerticalStackLayout>
    </ScrollView>
</ContentPage>