<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AMS.Views.PaymentFeesPage"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    Title="Chi phí">

    <ScrollView>
        <VerticalStackLayout Padding="14" Spacing="14">

            <!-- Default fee rates -->
            <Frame Padding="10" BorderColor="#CFD8DC" CornerRadius="10">
                <VerticalStackLayout Spacing="8">
                    <Label Text="Phí mặc định" FontAttributes="Bold" FontSize="18"/>
                    <Grid ColumnDefinitions="Auto,Auto,Auto,Auto" ColumnSpacing="12" RowDefinitions="Auto,Auto">
                        <Label Grid.Column="0" Grid.Row="0" Text="Điện (đ/kWh)" />
                        <Entry Grid.Column="1" Grid.Row="0" WidthRequest="120" Keyboard="Numeric" Text="{Binding DefaultElectricRate}"/>
                        <Label Grid.Column="2" Grid.Row="0" Text="Nước (đ/m³)" />
                        <Entry Grid.Column="3" Grid.Row="0" WidthRequest="120" Keyboard="Numeric" Text="{Binding DefaultWaterRate}"/>

                        <Label Grid.Column="0" Grid.Row="1" Text="Internet (đ/phòng)" />
                        <Entry Grid.Column="1" Grid.Row="1" WidthRequest="120" Keyboard="Numeric" Text="{Binding DefaultInternetFlat}"/>
                        <Label Grid.Column="2" Grid.Row="1" Text="Vệ sinh (đ/phòng)" />
                        <Entry Grid.Column="3" Grid.Row="1" WidthRequest="120" Keyboard="Numeric" Text="{Binding DefaultCleaningFlat}"/>
                    </Grid>
                    <Button Text="Lưu phí mặc định" Command="{Binding SaveDefaultFeesCommand}" WidthRequest="180" HorizontalOptions="Start"/>
                </VerticalStackLayout>
            </Frame>

            <!-- Custom fee types -->
            <Frame Padding="10" BorderColor="#CFD8DC" CornerRadius="10">
                <VerticalStackLayout Spacing="8">
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="Loại phí tùy chỉnh" FontAttributes="Bold" FontSize="18" />
                        <Button Text="Thêm loại phí" Command="{Binding AddFeeTypeCommand}" />
                        <Button Text="Lưu thay đổi" Command="{Binding SaveFeeTypesCommand}" />
                    </HorizontalStackLayout>

                    <CollectionView ItemsSource="{Binding FeeTypes}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto" ColumnSpacing="8" Padding="0,6">
                                    <Label Grid.Column="0" Text="{Binding Name}" />
                                    <Switch Grid.Column="1" IsToggled="{Binding IsRecurring}" />
                                    <Entry  Grid.Column="2" WidthRequest="120" Placeholder="Đơn giá" Keyboard="Numeric" Text="{Binding DefaultRate}"/>
                                    <Entry  Grid.Column="3" WidthRequest="120" Placeholder="Đơn vị" Text="{Binding UnitLabel}"/>
                                    <Switch Grid.Column="4" IsToggled="{Binding Active}" />
                                </Grid>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

            <!-- Per-room fees -->
            <Frame Padding="10" BorderColor="#CFD8DC" CornerRadius="10">
                <VerticalStackLayout Spacing="8">
                    <Label Text="Phí theo phòng (chu kỳ hiện tại)" FontAttributes="Bold" FontSize="18" />
                    <CollectionView ItemsSource="{Binding RoomCharges}" SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate>
                                <Frame Padding="8" BorderColor="#ECEFF1" CornerRadius="8" Margin="0,6">
                                    <VerticalStackLayout Spacing="6">
                                        <HorizontalStackLayout Spacing="8">
                                            <Label Text="{Binding RoomCode}" FontAttributes="Bold"/>
                                            <Label Text="{Binding TotalFees, StringFormat='Tổng phí: {0:N0} đ'}" TextColor="#455A64"/>
                                        </HorizontalStackLayout>

                                        <CollectionView ItemsSource="{Binding Fees}" SelectionMode="None">
                                            <CollectionView.ItemTemplate>
                                                <DataTemplate>
                                                    <Grid ColumnDefinitions="*,Auto,Auto,Auto" ColumnSpacing="8" Padding="0,4">
                                                        <Label Grid.Column="0" Text="{Binding Name}"/>
                                                        <Entry Grid.Column="1" WidthRequest="90" Text="{Binding Quantity}" Keyboard="Numeric"/>
                                                        <Entry Grid.Column="2" WidthRequest="110" Text="{Binding Rate}" Keyboard="Numeric"/>
                                                        <Label Grid.Column="3" Text="{Binding Amount, StringFormat='{0:N0} đ'}"/>
                                                    </Grid>
                                                </DataTemplate>
                                            </CollectionView.ItemTemplate>
                                        </CollectionView>

                                        <Button Text="Thêm phí vào phòng"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.AddFeeToRoomCommand}"
                                                CommandParameter="{Binding .}" />
                                    </VerticalStackLayout>
                                </Frame>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Frame>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>